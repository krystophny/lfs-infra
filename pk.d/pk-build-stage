#!/bin/sh
# pk-build-stage - build all packages in a stage
# Usage: pk build-stage <stage_number>

SCRIPT_DIR="$(dirname "$0")"
. "$SCRIPT_DIR/pk-common"

[ $# -ge 1 ] || die "usage: pk build-stage <stage_number>"

stage="$1"

# Find packages.toml
TOML_FILE=""
for f in "./packages.toml" "$SCRIPT_DIR/../packages.toml" "/etc/pk/packages.toml"; do
    [ -f "$f" ] && TOML_FILE="$(cd "$(dirname "$f")" && pwd)/$(basename "$f")" && break
done
[ -n "$TOML_FILE" ] || die "packages.toml not found"

info "building stage $stage packages from $TOML_FILE"

# Extract packages for this stage, sorted by build_order
packages=$(awk -v stage="$stage" '
    /^\[packages\./ {
        pkg = $0
        gsub(/\[packages\.|\]/, "", pkg)
        current_pkg = pkg
        build_order = 999
    }
    /^stage = / && $3 == stage { in_stage = 1 }
    /^build_order = / && in_stage { build_order = $3 }
    /^$/ && in_stage {
        print build_order, current_pkg
        in_stage = 0
        build_order = 999
    }
    END { if (in_stage) print build_order, current_pkg }
' "$TOML_FILE" | sort -n | awk '{print $2}')

if [ -z "$packages" ]; then
    die "no packages found for stage $stage"
fi

count=$(echo "$packages" | wc -l)
info "found $count packages for stage $stage"

failed=""
i=0
for pkg in $packages; do
    i=$((i + 1))
    info "[$i/$count] building $pkg"

    # Check if already installed
    if [ -d "$DB_DIR/$pkg" ]; then
        info "$pkg already installed, skipping"
        continue
    fi

    # Download source
    "$SCRIPT_DIR/pk-download" "$pkg" || { warn "download failed: $pkg"; failed="$failed $pkg"; continue; }

    # Build package
    "$SCRIPT_DIR/pk-build" "$pkg" || { warn "build failed: $pkg"; failed="$failed $pkg"; continue; }

    # Install package
    pkg_file="$CACHE_DIR/${pkg}-*.pk.tar.xz"
    "$SCRIPT_DIR/pk-install" $pkg_file || { warn "install failed: $pkg"; failed="$failed $pkg"; continue; }

    info "$pkg completed"
done

if [ -n "$failed" ]; then
    warn "failed packages:$failed"
    exit 1
fi

info "stage $stage complete"
