#!/bin/sh
# pk-common - shared functions for pk package manager
# Sourced by pk subcommands

VERSION="0.0.2"

# Paths
DB_DIR="${PK_ROOT:-}/var/lib/pk"
CACHE_DIR="${PK_ROOT:-}/var/cache/pk"
SOURCES_DIR="${PK_ROOT:-}/usr/src"

die() { echo "pk: $*" >&2; exit 1; }
warn() { echo "pk: warning: $*" >&2; }
info() { echo "pk: $*"; }

# Check if running in chroot
is_in_chroot() {
    [ "$(stat -c %i / 2>/dev/null)" != "2" ] && return 0
    [ -r /proc/1/root ] && [ "$(readlink -f /proc/1/root 2>/dev/null)" != "/" ] && return 0
    return 1
}

# Safety check - prevent accidental installation to host
safety_check() {
    if [ -z "${PK_ROOT:-}" ]; then
        if ! is_in_chroot; then
            if [ "${PK_FORCE_ROOT:-0}" != "1" ]; then
                die "SAFETY ERROR - PK_ROOT is not set and you're on the HOST system!
Set PK_ROOT=/mnt/lfs or PK_FORCE_ROOT=1 to override."
            fi
        fi
    fi
}

# Parse package name and version from filename
# foo-1.2.3.pkg.tar.xz -> name=foo version=1.2.3
parse_pkgname() {
    local basename="${1##*/}"
    basename="${basename%.pkg.tar*}"
    basename="${basename%.tar*}"

    local name="" version="" char="" rest=""
    rest="$basename"
    while [ -n "$rest" ]; do
        char="${rest%"${rest#?}"}"
        rest="${rest#?}"
        if [ "$char" = "-" ]; then
            next="${rest%"${rest#?}"}"
            case "$next" in
                [0-9])
                    version="$rest"
                    break
                    ;;
            esac
        fi
        name="${name}${char}"
    done

    [ -z "$name" ] && name="$basename"
    [ -z "$version" ] && version="unknown"

    echo "$name" "$version"
}

# Get all tracked files (with symlink-aware paths)
get_tracked_files() {
    cat "$DB_DIR"/*/files 2>/dev/null | \
        sed 's|^\./|/|' | \
        sed 's|^/bin/|/usr/bin/|; s|^/sbin/|/usr/sbin/|; s|^/lib/|/usr/lib/|' | \
        grep -v '^/$' | sort -u
}
