#!/bin/sh
# runit stage 3: shutdown
# Clean shutdown sequence

PATH=/sbin:/bin:/usr/sbin:/usr/bin

# Stop all services
sv -w196 force-stop /etc/runit/runsvdir/current/*
sv exit /etc/runit/runsvdir/current/*

# Save random seed
dd if=/dev/urandom of=/var/lib/random-seed count=1 bs=512 2>/dev/null

# Save hardware clock
hwclock -w 2>/dev/null

# Send TERM signal to all processes (use pkill -9 as fallback if killall5 unavailable)
if command -v killall5 >/dev/null 2>&1; then
    killall5 -15
    sleep 2
    killall5 -9
else
    pkill -15 -v -P 1 2>/dev/null || true
    sleep 2
    pkill -9 -v -P 1 2>/dev/null || true
fi
sleep 1

# Unmount filesystems
umount -a -r 2>/dev/null

# Sync disks
sync

# Final action based on runlevel
case "$1" in
    0) poweroff -f ;;
    6) reboot -f ;;
esac
