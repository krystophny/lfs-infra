#!/bin/sh
# runit stage 3: shutdown
# Clean shutdown sequence

PATH=/sbin:/bin:/usr/sbin:/usr/bin

# Stop all services
sv -w196 force-stop /etc/runit/runsvdir/current/*
sv exit /etc/runit/runsvdir/current/*

# Save random seed
dd if=/dev/urandom of=/var/lib/random-seed count=1 bs=512 2>/dev/null

# Save hardware clock
hwclock -w 2>/dev/null

# Send TERM signal to all processes
killall5 -15
sleep 2

# Send KILL signal to stragglers
killall5 -9
sleep 1

# Unmount filesystems
umount -a -r 2>/dev/null

# Sync disks
sync

# Final action based on runlevel
case "$1" in
    0) poweroff -f ;;
    6) reboot -f ;;
esac
