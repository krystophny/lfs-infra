#!/bin/bash
# LFS Init Script - Minimal init for XFCE desktop

# Mount essential filesystems
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t devtmpfs devtmpfs /dev
mount -t tmpfs tmpfs /run
mkdir -p /dev/pts /dev/shm
mount -t devpts devpts /dev/pts
mount -t tmpfs tmpfs /dev/shm
mount -o remount,rw /

# Create device nodes if missing
[ -e /dev/null ] || mknod -m 666 /dev/null c 1 3
[ -e /dev/console ] || mknod -m 600 /dev/console c 5 1
[ -e /dev/tty ] || mknod -m 666 /dev/tty c 5 0
[ -e /dev/tty1 ] || mknod -m 666 /dev/tty1 c 4 1
[ -e /dev/ttyS0 ] || mknod -m 666 /dev/ttyS0 c 4 64

echo "lfs" > /proc/sys/kernel/hostname

# Boot message
{
    echo ""
    echo "=============================================="
    echo "  Linux From Scratch - Boot Successful!"
    echo "  Kernel: $(uname -r)"
    echo "=============================================="
    echo "Boot time: $(cut -d' ' -f1 /proc/uptime) seconds"
    echo ""
} > /dev/ttyS0 2>&1

# Start udevd for device management (required for X input)
echo "Starting udev..." > /dev/ttyS0
/sbin/udevd --daemon
udevadm trigger --action=add --type=subsystems
udevadm trigger --action=add --type=devices
udevadm settle
echo "udev ready" > /dev/ttyS0

# Environment setup
export HOME=/root
export DISPLAY=:0
export XDG_RUNTIME_DIR=/run/user/0
export DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/0/bus
export PATH=/usr/bin:/usr/sbin:/bin:/sbin
mkdir -p /run/user/0 /run/dbus /var/run/dbus
chmod 700 /run/user/0

# Start D-Bus system daemon
echo "Starting D-Bus..." > /dev/ttyS0
/usr/bin/dbus-daemon --system --fork 2>/dev/null

# Start D-Bus session daemon
/usr/bin/dbus-daemon --session --address="$DBUS_SESSION_BUS_ADDRESS" --fork 2>/dev/null
echo "D-Bus ready" > /dev/ttyS0

# Start X server
echo "Starting X server..." > /dev/ttyS0
cd /root
rm -f /tmp/.X0-lock /tmp/.X11-unix/X0 2>/dev/null
mkdir -p /tmp/.X11-unix
/usr/bin/Xorg :0 vt1 -keeptty 2>/var/log/Xorg.0.log &

# Wait for X server
for i in $(seq 1 30); do
    [ -e /tmp/.X11-unix/X0 ] && break
    sleep 0.2
done
echo "X server ready" > /dev/ttyS0

# Start XFCE session
echo "Starting XFCE..." > /dev/ttyS0
env DISPLAY=:0 HOME=/root XDG_RUNTIME_DIR=/run/user/0 \
    DBUS_SESSION_BUS_ADDRESS="$DBUS_SESSION_BUS_ADDRESS" \
    /usr/bin/startxfce4 2>/var/log/xfce.log &

sleep 3
echo "Desktop ready - XFCE running" > /dev/ttyS0

exec /bin/bash </dev/ttyS0 >/dev/ttyS0 2>&1
