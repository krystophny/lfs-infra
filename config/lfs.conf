# LFS Configuration
# Core paths and settings for the LFS build

# =============================================================================
# LFS Target Configuration
# =============================================================================

# LFS build directory (override via LFS_BUILD_DIR environment variable)
LFS="${LFS_BUILD_DIR:-/var/tmp/ert}"

# Target triplet (auto-detected if empty)
LFS_TGT="${LFS_TGT:-$(uname -m)-lfs-linux-gnu}"

# Host triplet
LFS_HOST="$(gcc -dumpmachine)"

# =============================================================================
# Directory Structure
# =============================================================================

# Source tarballs
LFS_SOURCES="${LFS}/sources"

# Build directory (use tmpfs/ramdisk if available for speed)
LFS_BUILD="${LFS}/build"

# Tools directory (cross-compiler, temporary tools)
LFS_TOOLS="${LFS}/tools"

# Package installation root
LFS_PKG="${LFS}/pkg"

# Log directory
LFS_LOGS="${LFS}/logs"

# =============================================================================
# fay Configuration (Fast Archive Yielder)
# =============================================================================

# fay database location
FAY_DB="${LFS}/var/lib/fay"

# Package archive directory
FAY_PKG="${LFS_PKG}"

# Package compression
FAY_COMPRESSION="xz"

# =============================================================================
# Network Configuration
# =============================================================================

# Download mirrors (in order of preference)
GNU_MIRROR="https://ftp.gnu.org/gnu"
KERNEL_MIRROR="https://cdn.kernel.org/pub/linux/kernel"
GITHUB_MIRROR="https://github.com"

# Download tool (curl or wget)
DOWNLOAD_TOOL="curl"
DOWNLOAD_OPTS="-fsSL --retry 3 --retry-delay 5"

# =============================================================================
# Build Configuration
# =============================================================================

# Enable parallel builds
PARALLEL_BUILDS=1

# Number of parallel jobs (0 = auto-detect)
PARALLEL_JOBS=0

# Enable ccache if available
USE_CCACHE=1

# ccache directory
CCACHE_DIR="${LFS}/.ccache"

# Maximum ccache size
CCACHE_SIZE="20G"

# =============================================================================
# Git Build Configuration
# =============================================================================

# Default to release tarballs, set to 1 to use git HEAD
USE_GIT_DEFAULT=0

# Shallow clone depth for git (0 = full clone)
GIT_DEPTH=1

# =============================================================================
# Logging Configuration
# =============================================================================

# Log level: debug, info, warn, error
LOG_LEVEL="info"

# Keep build logs
KEEP_LOGS=1

# Colorize output
COLOR_OUTPUT=1

# =============================================================================
# Safety Configuration
# =============================================================================

# Stop on first error
STOP_ON_ERROR=1

# Verify checksums before building
VERIFY_CHECKSUMS=1

# Clean build directory after successful build
CLEAN_BUILD=1

# =============================================================================
# Kernel Configuration
# =============================================================================

# Kernel config file (empty = use defconfig + localmodconfig)
KERNEL_CONFIG=""

# Enable kernel modules
KERNEL_MODULES=1

# =============================================================================
# Helper Functions
# =============================================================================

# Load this configuration
lfs_load_config() {
    # Ensure LFS is set
    if [ -z "${LFS}" ]; then
        echo "ERROR: LFS variable not set"
        return 1
    fi

    # Create directory structure if needed
    for dir in "${LFS_SOURCES}" "${LFS_BUILD}" "${LFS_TOOLS}" "${LFS_PKG}" "${LFS_LOGS}"; do
        [ -d "${dir}" ] || mkdir -p "${dir}"
    done

    # Auto-detect parallel jobs
    if [ "${PARALLEL_JOBS}" -eq 0 ]; then
        PARALLEL_JOBS=$(nproc)
    fi

    export LFS LFS_TGT LFS_SOURCES LFS_BUILD LFS_TOOLS LFS_PKG LFS_LOGS
    export MAKEFLAGS="-j${PARALLEL_JOBS}"
}

# Validate LFS environment
lfs_validate() {
    local errors=0

    # Check LFS mount
    if ! mountpoint -q "${LFS}" 2>/dev/null; then
        echo "WARNING: ${LFS} is not a mount point"
    fi

    # Check available space (need at least 30GB)
    local avail=$(df -BG "${LFS}" 2>/dev/null | awk 'NR==2 {print $4}' | tr -d 'G')
    if [ -n "${avail}" ] && [ "${avail}" -lt 30 ]; then
        echo "WARNING: Less than 30GB available on ${LFS} (${avail}GB)"
    fi

    # Check for required host tools
    for tool in gcc g++ make bison flex; do
        if ! command -v "${tool}" >/dev/null 2>&1; then
            echo "ERROR: Required tool not found: ${tool}"
            errors=$((errors + 1))
        fi
    done

    return ${errors}
}
