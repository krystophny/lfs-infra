# LFS Configuration
# Core paths and settings for the LFS build

# =============================================================================
# Directory Structure (FHS-compliant)
# =============================================================================

# Source directory - tarballs and extracted sources live here together
# e.g., /usr/src/gcc-16.1.0.tar.xz and /usr/src/gcc-16.1.0/
# Note: During install, LFS=/mnt/lfs; after boot, LFS="" (paths are absolute)
LFS_SOURCES="${LFS}/usr/src"

# Bootstrap tools directory (cross-compiler, deleted after build)
# Temporary location - remove with: pk r binutils-pass1 gcc-pass1 ... && rm -rf /var/tmp/lfs-bootstrap
LFS_BOOTSTRAP="${LFS}/var/tmp/lfs-bootstrap"

# Built package archives (.pkg.tar.xz)
LFS_PKGCACHE="${LFS}/var/cache/pk"

# Package manager database
PK_DB="${LFS}/var/lib/pk"

# Build logs
LFS_LOGS="${LFS}/var/log/lfs-build"

# =============================================================================
# Target Configuration
# =============================================================================

# Target triplet (auto-detected if empty)
LFS_TGT="${LFS_TGT:-$(uname -m)-lfs-linux-gnu}"

# Host triplet
LFS_HOST="$(gcc -dumpmachine)"

# =============================================================================
# pk Configuration (Package Manager)
# =============================================================================

# Package compression
PK_COMPRESSION="xz"

# =============================================================================
# Network Configuration
# =============================================================================

# Download mirrors (in order of preference)
GNU_MIRROR="https://ftp.gnu.org/gnu"
KERNEL_MIRROR="https://cdn.kernel.org/pub/linux/kernel"
GITHUB_MIRROR="https://github.com"

# Download tool (curl or wget)
DOWNLOAD_TOOL="curl"
DOWNLOAD_OPTS="-fsSL --retry 3 --retry-delay 5"

# =============================================================================
# Build Configuration
# =============================================================================

# Number of parallel jobs (0 = auto-detect = nproc)
PARALLEL_JOBS=0

# Enable ccache if available
USE_CCACHE=1
CCACHE_DIR="/var/cache/ccache"
CCACHE_SIZE="20G"

# =============================================================================
# Git Build Configuration
# =============================================================================

# Default to release tarballs, set to 1 to use git HEAD
USE_GIT_DEFAULT=0

# Shallow clone depth for git (0 = full clone)
GIT_DEPTH=1

# =============================================================================
# Logging Configuration
# =============================================================================

# Log level: debug, info, warn, error
LOG_LEVEL="info"

# Keep build logs
KEEP_LOGS=1

# Colorize output
COLOR_OUTPUT=1

# =============================================================================
# Safety Configuration
# =============================================================================

# Stop on first error
STOP_ON_ERROR=1

# Verify checksums before building
VERIFY_CHECKSUMS=1

# Clean build directory after successful build
CLEAN_BUILD=1

# =============================================================================
# Kernel Configuration
# =============================================================================

# Kernel config file (empty = use defconfig + localmodconfig)
KERNEL_CONFIG=""

# Enable kernel modules
KERNEL_MODULES=1

# =============================================================================
# Helper Functions
# =============================================================================

# Load this configuration
lfs_load_config() {
    # Auto-detect parallel jobs
    if [ "${PARALLEL_JOBS}" -eq 0 ]; then
        PARALLEL_JOBS=$(nproc)
    fi

    export LFS_TGT LFS_SOURCES LFS_BOOTSTRAP LFS_PKGCACHE LFS_LOGS
    export MAKEFLAGS="-j${PARALLEL_JOBS}"
}

# Ensure build directories exist with proper permissions
lfs_init_dirs() {
    # These should be created by install.sh with user:src ownership
    for dir in "${LFS_SOURCES}" "${LFS_BOOTSTRAP}" "${LFS_PKGCACHE}"; do
        [ -d "${dir}" ] || sudo mkdir -p "${dir}"
    done
    [ -d "${LFS_LOGS}" ] || sudo mkdir -p "${LFS_LOGS}"
}
